<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en-US">
  <head>
    <meta charset="utf-8">

    
      <style>
        html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield;box-sizing:content-box}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}code[class^='language-'] .gp{color:#c65d09;font-weight:700;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}body:not(.darkmode) code[class^='language-'] .hll{background-color:#ffc}body:not(.darkmode) code[class^='language-'] .c{color:#808080}body:not(.darkmode) code[class^='language-'] .err{color:#F00000;background-color:#F0A0A0}body:not(.darkmode) code[class^='language-'] .k{color:#008000;font-weight:700}body:not(.darkmode) code[class^='language-'] .o{color:#303030}body:not(.darkmode) code[class^='language-'] .cm{color:#808080}body:not(.darkmode) code[class^='language-'] .cp{color:#507090}body:not(.darkmode) code[class^='language-'] .c1{color:#808080}body:not(.darkmode) code[class^='language-'] .cs{color:#c00;font-weight:700}body:not(.darkmode) code[class^='language-'] .gd{color:#A00000}body:not(.darkmode) code[class^='language-'] .ge{font-style:italic}body:not(.darkmode) code[class^='language-'] .gr{color:red}body:not(.darkmode) code[class^='language-'] .gh{color:#000080;font-weight:700}body:not(.darkmode) code[class^='language-'] .gi{color:#00A000}body:not(.darkmode) code[class^='language-'] .go{color:#808080}body:not(.darkmode) code[class^='language-'] .gs{font-weight:700}body:not(.darkmode) code[class^='language-'] .gu{color:#800080;font-weight:700}body:not(.darkmode) code[class^='language-'] .gt{color:#0040D0}body:not(.darkmode) code[class^='language-'] .kc{color:#008000;font-weight:700}body:not(.darkmode) code[class^='language-'] .kd{color:#008000;font-weight:700}body:not(.darkmode) code[class^='language-'] .kn{color:#008000;font-weight:700}body:not(.darkmode) code[class^='language-'] .kp{color:#003080;font-weight:700}body:not(.darkmode) code[class^='language-'] .kr{color:#008000;font-weight:700}body:not(.darkmode) code[class^='language-'] .kt{color:#303090;font-weight:700}body:not(.darkmode) code[class^='language-'] .m{color:#6000E0;font-weight:700}body:not(.darkmode) code[class^='language-'] .s{background-color:#fff0f0}body:not(.darkmode) code[class^='language-'] .na{color:#0000C0}body:not(.darkmode) code[class^='language-'] .nb{color:#007020}body:not(.darkmode) code[class^='language-'] .nc{color:#B00060;font-weight:700}body:not(.darkmode) code[class^='language-'] .no{color:#003060;font-weight:700}body:not(.darkmode) code[class^='language-'] .nd{color:#505050;font-weight:700}body:not(.darkmode) code[class^='language-'] .ni{color:#800000;font-weight:700}body:not(.darkmode) code[class^='language-'] .ne{color:#F00000;font-weight:700}body:not(.darkmode) code[class^='language-'] .nf{color:#0060B0;font-weight:700}body:not(.darkmode) code[class^='language-'] .nl{color:#907000;font-weight:700}body:not(.darkmode) code[class^='language-'] .nn{color:#0e84b5;font-weight:700}body:not(.darkmode) code[class^='language-'] .nt{color:#007000}body:not(.darkmode) code[class^='language-'] .nv{color:#906030}body:not(.darkmode) code[class^='language-'] .ow{color:#000;font-weight:700}body:not(.darkmode) code[class^='language-'] .w{color:#bbb}body:not(.darkmode) code[class^='language-'] .mf{color:#6000E0;font-weight:700}body:not(.darkmode) code[class^='language-'] .mh{color:#005080;font-weight:700}body:not(.darkmode) code[class^='language-'] .mi{color:#0000D0;font-weight:700}body:not(.darkmode) code[class^='language-'] .mo{color:#4000E0;font-weight:700}body:not(.darkmode) code[class^='language-'] .sb{background-color:#fff0f0}body:not(.darkmode) code[class^='language-'] .sc{color:#0040D0}body:not(.darkmode) code[class^='language-'] .sd{color:#D04020}body:not(.darkmode) code[class^='language-'] .s2{background-color:#fff0f0}body:not(.darkmode) code[class^='language-'] .se{color:#606060;font-weight:700;background-color:#fff0f0}body:not(.darkmode) code[class^='language-'] .sh{background-color:#fff0f0}body:not(.darkmode) code[class^='language-'] .si{background-color:#e0e0e0}body:not(.darkmode) code[class^='language-'] .sx{color:#D02000;background-color:#fff0f0}body:not(.darkmode) code[class^='language-'] .sr{color:#000;background-color:#fff0ff}body:not(.darkmode) code[class^='language-'] .s1{background-color:#fff0f0}body:not(.darkmode) code[class^='language-'] .ss{color:#A06000}body:not(.darkmode) code[class^='language-'] .bp{color:#007020}body:not(.darkmode) code[class^='language-'] .vc{color:#306090}body:not(.darkmode) code[class^='language-'] .vg{color:#d07000;font-weight:700}body:not(.darkmode) code[class^='language-'] .vi{color:#3030B0}body:not(.darkmode) code[class^='language-'] .il{color:#0000D0;font-weight:700}body{background:#F5F7F6;color:#000;margin:0;padding:0;max-width:720px;text-rendering:optimizelegibility;font-family:Palatino,serif;line-height:20px}#sidebar{margin:15px;float:left;width:205px;padding:10px 0;background-color:#FFF;box-shadow:0 0 5px 0 rgba(0,0,0,0.5);transition:margin-left 1s}#sidebar.collapsed{margin-left:-180px}#sidebar ul{padding:0 1em;margin:0;list-style-type:none}#sidebar li:before{content:'⁃';padding-right:.5em;color:#000}#sidebar li.visited:before{content:'✔';padding-right:.2em;color:green}.abs-hamburger{position:relative;width:0;height:0}.nav-toggle{position:absolute;left:175px;width:25px;height:25px;cursor:pointer;margin-right:5px;margin-bottom:5px}.nav-toggle span,.nav-toggle span:before,.nav-toggle span:after{border-radius:1px;height:5px;width:25px;background:#fff;position:absolute;display:block;content:'';box-shadow:inset 0 0 2px 0 #000}.nav-toggle span:before{top:-8px}.nav-toggle span:after{bottom:-8px}.nav-toggle span{margin-top:9.5px}#nextprev{overflow:hidden;padding:.5em 1em}.text-icon{font-size:5em}#arrow-prev{float:left}#arrow-next{float:right}article{margin:15px;transition:max-width 1s}article.expanded{max-width:680px}a{text-decoration:none}a:link,a:visited{color:#B45D47}a:hover{color:#FE3B3B}a.disabled,a:link.disabled,a:visited.disabled{color:#999;pointer-events:none}a:hover.disabled{color:#888}pre,code{font-family:Monaco,Menlo,Consolas,"Courier New",monospace}code{border-radius:1px;background-color:#FFF;padding:.2em}pre code{display:block;padding:1em;white-space:pre-wrap}h1,h2,h3,h4,h5,h6{line-height:125%}footer{margin-top:50px;clear:both;text-align:center;color:#777}footer ul{list-style:none;margin:0;padding:0}footer li{display:inline}footer li+li:before{content:'|'}footer a:link,footer a:visited{color:#777}footer a:hover{color:#999}.notransition{-webkit-transition:none !important;-moz-transition:none !important;-o-transition:none !important;-ms-transition:none !important;transition:none !important}@media screen and (min-width:925px){body{margin:0 auto}body #sidebar.collapsed,body #sidebar{margin-left:-205px}body article.expanded,body article{max-width:none;width:none;min-width:none}}@media screen and (max-width:1200px){body{margin-right:0}}body.darkmode code[class^='language-']{background-color:#333;color:#f8f8f2}body.darkmode code[class^='language-'] .hll{background-color:#49483e}body.darkmode code[class^='language-'] .c{color:#75715e}body.darkmode code[class^='language-'] .err{color:#960050;background-color:#1e0010}body.darkmode code[class^='language-'] .k{color:#66d9ef}body.darkmode code[class^='language-'] .l{color:#ae81ff}body.darkmode code[class^='language-'] .n{color:#f8f8f2}body.darkmode code[class^='language-'] .o{color:#f92672}body.darkmode code[class^='language-'] .p{color:#f8f8f2}body.darkmode code[class^='language-'] .cm{color:#75715e}body.darkmode code[class^='language-'] .cp{color:#75715e}body.darkmode code[class^='language-'] .c1{color:#75715e}body.darkmode code[class^='language-'] .cs{color:#75715e}body.darkmode code[class^='language-'] .ge{font-style:italic}body.darkmode code[class^='language-'] .gs{font-weight:700}body.darkmode code[class^='language-'] .kc{color:#66d9ef}body.darkmode code[class^='language-'] .kd{color:#66d9ef}body.darkmode code[class^='language-'] .kn{color:#f92672}body.darkmode code[class^='language-'] .kp{color:#66d9ef}body.darkmode code[class^='language-'] .kr{color:#66d9ef}body.darkmode code[class^='language-'] .kt{color:#66d9ef}body.darkmode code[class^='language-'] .ld{color:#e6db74}body.darkmode code[class^='language-'] .m{color:#ae81ff}body.darkmode code[class^='language-'] .s{color:#e6db74}body.darkmode code[class^='language-'] .na{color:#a6e22e}body.darkmode code[class^='language-'] .nb{color:#f8f8f2}body.darkmode code[class^='language-'] .nc{color:#a6e22e}body.darkmode code[class^='language-'] .no{color:#66d9ef}body.darkmode code[class^='language-'] .nd{color:#a6e22e}body.darkmode code[class^='language-'] .ni{color:#f8f8f2}body.darkmode code[class^='language-'] .ne{color:#a6e22e}body.darkmode code[class^='language-'] .nf{color:#a6e22e}body.darkmode code[class^='language-'] .nl{color:#f8f8f2}body.darkmode code[class^='language-'] .nn{color:#f8f8f2}body.darkmode code[class^='language-'] .nx{color:#a6e22e}body.darkmode code[class^='language-'] .py{color:#f8f8f2}body.darkmode code[class^='language-'] .nt{color:#f92672}body.darkmode code[class^='language-'] .nv{color:#f8f8f2}body.darkmode code[class^='language-'] .ow{color:#f92672}body.darkmode code[class^='language-'] .w{color:#f8f8f2}body.darkmode code[class^='language-'] .mf{color:#ae81ff}body.darkmode code[class^='language-'] .mh{color:#ae81ff}body.darkmode code[class^='language-'] .mi{color:#ae81ff}body.darkmode code[class^='language-'] .mo{color:#ae81ff}body.darkmode code[class^='language-'] .sb{color:#e6db74}body.darkmode code[class^='language-'] .sc{color:#e6db74}body.darkmode code[class^='language-'] .sd{color:#e6db74}body.darkmode code[class^='language-'] .s2{color:#e6db74}body.darkmode code[class^='language-'] .se{color:#ae81ff}body.darkmode code[class^='language-'] .sh{color:#e6db74}body.darkmode code[class^='language-'] .si{color:#e6db74}body.darkmode code[class^='language-'] .sx{color:#e6db74}body.darkmode code[class^='language-'] .sr{color:#e6db74}body.darkmode code[class^='language-'] .s1{color:#e6db74}body.darkmode code[class^='language-'] .ss{color:#e6db74}body.darkmode code[class^='language-'] .bp{color:#f8f8f2}body.darkmode code[class^='language-'] .vc{color:#f8f8f2}body.darkmode code[class^='language-'] .vg{color:#f8f8f2}body.darkmode code[class^='language-'] .vi{color:#f8f8f2}body.darkmode code[class^='language-'] .il{color:#ae81ff}body.darkmode code[class^='language-'] .gh{}body.darkmode code[class^='language-'] .gu{color:#75715e}body.darkmode code[class^='language-'] .gd{color:#f92672}body.darkmode code[class^='language-'] .gi{color:#a6e22e}
      </style>
      <script async src="/assets/js/all.js"></script>
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-58002512-1', 'auto');
    </script>

    <title>Nim by Example - OOP Macro</title>

    <meta name="generator" content="nanoc 3.8.0">
    <meta http-equiv="Default-Style" content="colorful">
    <meta name=viewport content="width=device-width, initial-scale=1">
  </head>
  <body>

    <div id="sidebar">
      <div class="abs-hamburger"><div class="nav-toggle" onclick="javascript:sidebarClick();"><span></span></div></div>
      <nav>
        <ul>
  <li><a href="/getting_started/">Getting Started</a></li>
  <li><a href="/hello_world/">Hello World</a></li>
  <li><a href="/variables/">Variables</a>
    <ul>
      <li><a href="/variables/result/">Result</a></li>
      <li><a href="/variables/type_casting_inference/">Type Casting and Inference</a></li>
    </ul>
  </li>
  <li><a href="/if_else_while/">If, Else, While</a></li>
  <li><a href="/case/">Case Statements</a></li>
  <li><a href="/for_iterators/">For Loops &amp; Iterators</a></li>
  <li><a href="/procs/">Procs</a></li>
  <li><a href="/procvars/">First Class Functions</a></li>
  <li><a href="/block/">Blocks</a></li>
  <li><a href="/primitives/">Primitive Types</a></li>
  <li><a href="/types/">Type Aliases</a></li>
  <li><a href="/types/objects/">Object Types</a></li>
  <li><a href="/types/enums/">Enum Types</a></li>
  <li><a href="/types/distinct/">Distinct Types</a></li>
  <li><a href="/strings/">Strings</a></li>
  <li><a href="/arrays/">Arrays</a></li>
  <li><a href="/seqs/">Seqs</a></li>
  <li><a href="/bitsets/">Bitsets</a></li>
  <li><a href="/varargs/">Varargs</a></li>
  <li><a href="/oop/">Object Oriented Programming</a></li>
  <li><a href="/oop_macro/">OOP Macro</a></li>
</ul>



      </nav>
    </div>

    <article>
      <!--- Thanks to fowl for creating this page, filwit for fixing some oddities -->

<h1 id="oop-macro">OOP Macro</h1>
<p>This is the code that we currently must write to use OOP in Nim:</p>

<pre><code class="language-nimrod"><span class="k">type</span> <span class="n">Animal</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">RootObj</span>
  <span class="n">name</span><span class="p">:</span> <span class="kt">string</span>
  <span class="n">age</span><span class="p">:</span> <span class="kt">int</span>
<span class="k">method</span> <span class="n">vocalize</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Animal</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"..."</span>
<span class="k">method</span> <span class="n">ageHumanYrs</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Animal</span><span class="p">):</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">age</span>

<span class="k">type</span> <span class="n">Dog</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">Animal</span>
<span class="k">method</span> <span class="n">vocalize</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Dog</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"woof"</span>
<span class="k">method</span> <span class="n">ageHumanYrs</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Dog</span><span class="p">):</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">age</span> <span class="o">*</span> <span class="mi">7</span>

<span class="k">type</span> <span class="n">Cat</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">Animal</span>
<span class="k">method</span> <span class="n">vocalize</span><span class="p">(</span><span class="n">this</span><span class="p">:</span> <span class="n">Cat</span><span class="p">):</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"meow"</span></code></pre>

<p>All these typedefs and <code>this: T</code> parameters are repetitive, so it’d be good to write a macro to mask them. Something like this would be best:</p>

<pre><code class="language-nimrod"><span class="n">class</span> <span class="n">Animal</span> <span class="k">of</span> <span class="n">RootObj</span><span class="p">:</span>
  <span class="kd">var</span> <span class="n">name</span><span class="p">:</span> <span class="kt">string</span>
  <span class="kd">var</span> <span class="n">age</span><span class="p">:</span> <span class="kt">int</span>
  <span class="k">method</span> <span class="n">vocalize</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"..."</span>
  <span class="k">method</span> <span class="n">age_human_yrs</span><span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">age</span> <span class="c"># `this` is injected</span>

<span class="n">class</span> <span class="n">Dog</span> <span class="k">of</span> <span class="n">Animal</span><span class="p">:</span>
  <span class="k">method</span> <span class="n">vocalize</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"woof"</span>
  <span class="k">method</span> <span class="n">age_human_yrs</span><span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">age</span> <span class="o">*</span> <span class="mi">7</span>

<span class="n">class</span> <span class="n">Cat</span> <span class="k">of</span> <span class="n">Animal</span><span class="p">:</span>
  <span class="k">method</span> <span class="n">vocalize</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"meow"</span></code></pre>

<p>To get that nice notation, we can use a macro:</p>

<pre><code class="language-nimrod"><span class="kn">import</span> <span class="n">macros</span>

<span class="k">macro</span> <span class="n">class</span><span class="o">*</span><span class="p">(</span><span class="n">head</span><span class="p">:</span> <span class="n">expr</span><span class="p">,</span> <span class="n">body</span><span class="p">:</span> <span class="n">stmt</span><span class="p">):</span> <span class="n">stmt</span> <span class="p">{.</span><span class="n">immediate</span><span class="p">.}</span> <span class="o">=</span>
  <span class="c"># The macro is immediate so that it doesn't</span>
  <span class="c"># resolve identifiers passed to it</span>

  <span class="kd">var</span> <span class="n">typeName</span><span class="p">,</span> <span class="n">baseName</span><span class="p">:</span> <span class="n">NimNode</span>

  <span class="k">if</span> <span class="n">head</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">nnkIdent</span><span class="p">:</span>
    <span class="c"># `head` is expression `typeName`</span>
    <span class="c"># echo head.treeRepr</span>
    <span class="c"># --------------------</span>
    <span class="c"># Ident !"Animal"</span>
    <span class="n">typeName</span> <span class="o">=</span> <span class="n">head</span>

  <span class="k">elif</span> <span class="n">head</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">nnkInfix</span> <span class="ow">and</span> <span class="o">$</span><span class="n">head</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="s">"of"</span><span class="p">:</span>
    <span class="c"># `head` is expression `typeName of baseClass`</span>
    <span class="c"># echo head.treeRepr</span>
    <span class="c"># --------------------</span>
    <span class="c"># Infix</span>
    <span class="c">#   Ident !"of"</span>
    <span class="c">#   Ident !"Animal"</span>
    <span class="c">#   Ident !"RootObj"</span>
    <span class="n">typeName</span> <span class="o">=</span> <span class="n">head</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
    <span class="n">baseName</span> <span class="o">=</span> <span class="n">head</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>

  <span class="k">else</span><span class="p">:</span>
    <span class="n">quit</span> <span class="s">"Invalid node: "</span> <span class="o">&amp;</span> <span class="n">head</span><span class="p">.</span><span class="n">lispRepr</span>

  <span class="c"># echo treeRepr(body)</span>
  <span class="c"># --------------------</span>
  <span class="c"># StmtList</span>
  <span class="c">#   VarSection</span>
  <span class="c">#     IdentDefs</span>
  <span class="c">#       Ident !"name"</span>
  <span class="c">#       Ident !"string"</span>
  <span class="c">#       Empty</span>
  <span class="c">#     IdentDefs</span>
  <span class="c">#       Ident !"age"</span>
  <span class="c">#       Ident !"int"</span>
  <span class="c">#       Empty</span>
  <span class="c">#   MethodDef</span>
  <span class="c">#     Ident !"vocalize"</span>
  <span class="c">#     Empty</span>
  <span class="c">#     Empty</span>
  <span class="c">#     FormalParams</span>
  <span class="c">#       Ident !"string"</span>
  <span class="c">#     Empty</span>
  <span class="c">#     Empty</span>
  <span class="c">#     StmtList</span>
  <span class="c">#       StrLit ...</span>
  <span class="c">#   MethodDef</span>
  <span class="c">#     Ident !"age_human_yrs"</span>
  <span class="c">#     Empty</span>
  <span class="c">#     Empty</span>
  <span class="c">#     FormalParams</span>
  <span class="c">#       Ident !"int"</span>
  <span class="c">#     Empty</span>
  <span class="c">#     Empty</span>
  <span class="c">#     StmtList</span>
  <span class="c">#       DotExpr</span>
  <span class="c">#         Ident !"this"</span>
  <span class="c">#         Ident !"age"</span>

  <span class="c"># create a new stmtList for the result</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">newStmtList</span><span class="p">()</span>

  <span class="c"># var declarations will be turned into object fields</span>
  <span class="kd">var</span> <span class="n">recList</span> <span class="o">=</span> <span class="n">newNimNode</span><span class="p">(</span><span class="n">nnkRecList</span><span class="p">)</span>

  <span class="c"># Iterate over the statements, adding `this: T`</span>
  <span class="c"># to the parameters of functions</span>
  <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">body</span><span class="p">.</span><span class="n">children</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">node</span><span class="p">.</span><span class="n">kind</span><span class="p">:</span>

      <span class="k">of</span> <span class="n">nnkMethodDef</span><span class="p">,</span> <span class="n">nnkProcDef</span><span class="p">:</span>
        <span class="c"># inject `this: T` into the arguments</span>
        <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="n">copyNimTree</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">p</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">newIdentDefs</span><span class="p">(</span><span class="s">ident"this"</span><span class="p">,</span> <span class="n">typeName</span><span class="p">))</span>
        <span class="n">node</span><span class="p">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">result</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

      <span class="k">of</span> <span class="n">nnkVarSection</span><span class="p">:</span>
        <span class="c"># variables get turned into fields of the type.</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="p">.</span><span class="n">children</span><span class="p">:</span>
          <span class="n">recList</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

  <span class="c"># The following prints out the AST structure:</span>
  <span class="c">#</span>
  <span class="c"># import macros</span>
  <span class="c"># dumptree:</span>
  <span class="c">#   type X = ref object of Y</span>
  <span class="c">#     z: int</span>
  <span class="c"># --------------------</span>
  <span class="c"># TypeSection</span>
  <span class="c">#   TypeDef</span>
  <span class="c">#     Ident !"X"</span>
  <span class="c">#     Empty</span>
  <span class="c">#     RefTy</span>
  <span class="c">#       ObjectTy</span>
  <span class="c">#         Empty</span>
  <span class="c">#         OfInherit</span>
  <span class="c">#           Ident !"Y"</span>
  <span class="c">#         RecList</span>
  <span class="c">#           IdentDefs</span>
  <span class="c">#             Ident !"z"</span>
  <span class="c">#             Ident !"int"</span>
  <span class="c">#             Empty</span>

  <span class="n">result</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
    <span class="k">if</span> <span class="n">baseName</span> <span class="o">==</span> <span class="kp">nil</span><span class="p">:</span>
      <span class="n">quote</span> <span class="n">do</span><span class="p">:</span>
        <span class="k">type</span> <span class="p">`</span><span class="n">typeName</span><span class="p">`</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="n">RootObj</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">quote</span> <span class="n">do</span><span class="p">:</span>
        <span class="k">type</span> <span class="p">`</span><span class="n">typeName</span><span class="p">`</span> <span class="o">=</span> <span class="k">ref</span> <span class="k">object</span> <span class="k">of</span> <span class="p">`</span><span class="n">baseName</span><span class="p">`</span>
  <span class="p">)</span>
  <span class="c"># Inspect the tree structure:</span>
  <span class="c">#</span>
  <span class="c"># echo result.treeRepr</span>
  <span class="c"># --------------------</span>
  <span class="c"># StmtList</span>
  <span class="c">#   StmtList</span>
  <span class="c">#     TypeSection</span>
  <span class="c">#       TypeDef</span>
  <span class="c">#         Ident !"Animal"</span>
  <span class="c">#         Empty</span>
  <span class="c">#         RefTy</span>
  <span class="c">#           ObjectTy</span>
  <span class="c">#             Empty</span>
  <span class="c">#             OfInherit</span>
  <span class="c">#               Ident !"RootObj"</span>
  <span class="c">#             Empty   &lt;= We want to replace this</span>
  <span class="c">#   MethodDef</span>
  <span class="c">#   ...</span>

  <span class="n">result</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">][</span><span class="mi">2</span><span class="o">][</span><span class="mi">0</span><span class="o">][</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="n">recList</span>

  <span class="c"># Lets inspect the human-readable version of the output</span>
  <span class="c"># echo repr(result)</span>
  <span class="c"># Output:</span>
  <span class="c">#  type</span>
  <span class="c">#    Animal = ref object of RootObj</span>
  <span class="c">#      name: string</span>
  <span class="c">#      age: int</span>
  <span class="c">#</span>
  <span class="c">#  method vocalize(this: Animal): string =</span>
  <span class="c">#    "..."</span>
  <span class="c">#</span>
  <span class="c">#  method age_human_yrs(this: Animal): int =</span>
  <span class="c">#    this.age</span>

<span class="c"># ---</span>

<span class="n">class</span> <span class="n">Animal</span> <span class="k">of</span> <span class="n">RootObj</span><span class="p">:</span>
  <span class="kd">var</span> <span class="n">name</span><span class="p">:</span> <span class="kt">string</span>
  <span class="kd">var</span> <span class="n">age</span><span class="p">:</span> <span class="kt">int</span>
  <span class="k">method</span> <span class="n">vocalize</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"..."</span>
  <span class="k">method</span> <span class="n">age_human_yrs</span><span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">age</span> <span class="c"># `this` is injected</span>

<span class="n">class</span> <span class="n">Dog</span> <span class="k">of</span> <span class="n">Animal</span><span class="p">:</span>
  <span class="k">method</span> <span class="n">vocalize</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"woof"</span>
  <span class="k">method</span> <span class="n">age_human_yrs</span><span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="n">this</span><span class="p">.</span><span class="n">age</span> <span class="o">*</span> <span class="mi">7</span>

<span class="n">class</span> <span class="n">Cat</span> <span class="k">of</span> <span class="n">Animal</span><span class="p">:</span>
  <span class="k">method</span> <span class="n">vocalize</span><span class="p">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s">"meow"</span>

<span class="c"># ---</span>

<span class="kd">var</span> <span class="n">animals</span><span class="p">:</span> <span class="kt">seq</span><span class="o">[</span><span class="n">Animal</span><span class="o">]</span> <span class="o">=</span> <span class="o">@[]</span>
<span class="n">animals</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dog</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">"Sparky"</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">animals</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Cat</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">"Mitten"</span><span class="p">,</span> <span class="n">age</span><span class="p">:</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
  <span class="n">echo</span> <span class="n">a</span><span class="p">.</span><span class="n">vocalize</span><span class="p">()</span>
  <span class="n">echo</span> <span class="n">a</span><span class="p">.</span><span class="n">age_human_yrs</span><span class="p">()</span></code></pre>
<pre><code class="language-console"><span class="gp">$</span> nim c -r oopmacro.nim
<span class="go">woof</span>
<span class="go">70</span>
<span class="go">meow</span>
<span class="go">10</span></code></pre>

    </article>

    <div id=nextprev>
      <a id=arrow-prev class="text-icon disabled" href="https://please-enable-js/">↽</a>
      <a id=arrow-next class="text-icon disabled" href="https://please-enable-js/">⇁</a>
    </div>

    <footer>
      <li><a href="https://github.com/flaviut/nim-by-example">Contribute</a></li><li
><a href="#" onclick="toggleDarkMode(); return false;">Toggle dark mode</a></li>


    </footer>
  </body>
</html>
